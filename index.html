    <!DOCTYPE html>
    <html lang="es">
    <head>
    <meta charset="UTF-8">
    <title>Entrega de Aguinaldos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
    body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    padding: 16px;
    background: #f5f5f9;
    }
    h2 { margin-bottom: 6px; }

    .card {
    background: #fff;
    border-radius: 12px;
    padding: 16px;
    max-width: 430px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 16px;
    }

    label {
    font-size: 0.85rem;
    display: block;
    margin-top: 8px;
    }

    input {
    width: 95%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-top: 4px;
    }

    button {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    background: #304ffe;
    color: #fff;
    }

    button.secondary { background: #e0e0e0; color: #333; }
    button.success { background: #00c853; }
    button:disabled { background: #bdbdbd; }

    .msg {
    margin-top: 8px;
    padding: 8px;
    border-radius: 6px;
    font-size: 0.85rem;
    }
    .msg.error { background: #ffebee; color: #b71c1c; }

    .stats-grid {
    display: grid;
    grid-template-columns: repeat(2,1fr);
    gap: 10px;
    }
    .stat-box {
    background: #f5f7ff;
    padding: 10px;
    border-radius: 8px;
    }
    .stat-label { font-size: 0.75rem; color: #555; }
    .stat-value { font-size: 1.4rem; font-weight: 700; }
    hr { margin: 14px 0; }
    </style>
    </head>

    <body>

    <h2>Entrega de Aguinaldos</h2>
    <p style="font-size:0.85rem;color:#666;">Buscar por DNI</p>

    <!-- RESUMEN -->
    <div class="card">
    <h3>Resumen</h3>
    <div class="stats-grid">
        <div class="stat-box">
        <div class="stat-label">Colaboradores</div>
        <div class="stat-value" id="totColab">0</div>
        </div>
        <div class="stat-box">
        <div class="stat-label">Con hijos</div>
        <div class="stat-value" id="totHijos">0</div>
        </div>
        <div class="stat-box">
        <div class="stat-label">Aguinaldos entregados</div>
        <div class="stat-value" id="totAguinaldo">0</div>
        </div>
        <div class="stat-box">
        <div class="stat-label">Panetones entregados</div>
        <div class="stat-value" id="totPaneton">0</div>
        </div>
    </div>
    </div>

    <!-- CONSULTA -->
    <div class="card">
    <label>DNI</label>
    <input id="dniInput" placeholder="Ej: 10559647">
    <button id="btnConsultar">Consultar</button>
    <div id="resultado"></div>
    </div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    /* FIREBASE */
    const firebaseConfig = {
    apiKey: "AIzaSyAzq_xY_ne792xmhgDle_riU6qs471jjcw",
    authDomain: "aguinaldos-d782e.firebaseapp.com",
    databaseURL: "https://aguinaldos-d782e-default-rtdb.firebaseio.com",
    projectId: "aguinaldos-d782e",
    storageBucket: "aguinaldos-d782e.firebasestorage.app",
    messagingSenderId: "600911662448",
    appId: "1:600911662448:web:05908a9310528dcccf93b5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* DOM */
    const dniInput = document.getElementById("dniInput");
    const resultado = document.getElementById("resultado");

    const totColab = document.getElementById("totColab");
    const totHijos = document.getElementById("totHijos");
    const totAguinaldo = document.getElementById("totAguinaldo");
    const totPaneton = document.getElementById("totPaneton");

    let cache = [];

    /* ======================
    CARGA DE DATOS
    ====================== */
    onValue(ref(db, "aguinaldo"), snap => {
    cache = [];
    let col=0,h=0,a=0,p=0;

    snap.forEach(c => {
        const d = c.val();
        d._dni = c.key;
        cache.push(d);

        col++;
        if (d.HIJOS > 0) h++;
        if (d.ENTREGA?.AGUINALDO?.ENTREGADO) a++;
        if (d.ENTREGA?.PANETON?.ENTREGADO) p++;
    });

    totColab.textContent = col;
    totHijos.textContent = h;
    totAguinaldo.textContent = a;
    totPaneton.textContent = p;
    });

    /* ======================
    CONSULTA
    ====================== */
    document.getElementById("btnConsultar").onclick = () => {
    const dni = dniInput.value.trim();
    resultado.innerHTML = "";

    const r = cache.find(x => x._dni === dni);
    if (!r) {
        resultado.innerHTML = `<div class="msg error">DNI no registrado</div>`;
        return;
    }

    const entrega = r.ENTREGA || {};
    const hijos = Number(r.HIJOS || 0);
    const tarjetasEntregadas = entrega.HIJOS?.TARJETAS?.ENTREGADO;

    let inputsHijos = "";
    if (hijos > 0) {
        for (let i = 1; i <= hijos; i++) {
        inputsHijos += `
            <label>Código tarjeta hijo ${i}</label>
            <input class="codigoHijo"
            data-hijo="${i}"
            ${tarjetasEntregadas ? "disabled" : ""}
            value="${tarjetasEntregadas ? (entrega.HIJOS?.TARJETAS?.CODIGOS?.[`hijo${i}`] || "") : ""}">
        `;
        }
    }

    resultado.innerHTML = `

        <p><strong>${r["APELLIDOS Y NOMBRES"]}</strong></p>
        <p>Planilla: ${r.PLANILLA}</p>
        <p>Aguinaldo: ${r.AGUINALDO}</p>
        <p>Panetón grande: ${r.PANETON}</p>

        <hr>
        <label>Código Aguinaldo</label>
        <input id="codAguinaldo" ${entrega.AGUINALDO?.ENTREGADO?"disabled":""}>
        <button id="btnAguinaldo" class="success"
        ${entrega.AGUINALDO?.ENTREGADO?"disabled":""}>
        ${entrega.AGUINALDO?.ENTREGADO?"Aguinaldo entregado":"Registrar aguinaldo"}
        </button>

        <button id="btnPaneton" class="success"
        ${entrega.PANETON?.ENTREGADO?"disabled":""}>
        ${entrega.PANETON?.ENTREGADO?"Panetón entregado":"Confirmar panetón"}
        </button>

        ${hijos > 0 ? `
        <hr>
        <strong>Tarjetas por hijo</strong>
        ${inputsHijos}
        <button id="btnTarjetasHijos" class="success"
            ${tarjetasEntregadas ? "disabled" : ""}>
            ${tarjetasEntregadas ? "Tarjetas hijos registradas" : "Registrar tarjetas hijos"}
        </button>

        <hr>
        <strong>Otros</strong>
        <button id="btnPanetoncito" class="success"
            ${entrega.HIJOS?.PANETONCITO?.ENTREGADO?"disabled":""}>
            ${entrega.HIJOS?.PANETONCITO?.ENTREGADO?"Panetoncitos entregados":"Confirmar panetoncitos"}
        </button>

        <button id="btnSorpresa" class="success"
            ${entrega.HIJOS?.SORPRESA?.ENTREGADO?"disabled":""}>
            ${entrega.HIJOS?.SORPRESA?.ENTREGADO?"Sorpresas entregadas":"Confirmar sorpresas"}
        </button>
        ` : ""}
    `;

    /* AGUINALDO */
    if (!entrega.AGUINALDO?.ENTREGADO) {
        document.getElementById("btnAguinaldo").onclick = async () => {
        const c = document.getElementById("codAguinaldo").value.trim();
        if (!c) return alert("Ingrese código");

        await update(ref(db,`aguinaldo/${dni}/ENTREGA/AGUINALDO`),{
            ENTREGADO:true,
            CODIGO:c,
            FECHA:new Date().toISOString()
        });
        alert("Aguinaldo registrado ✔");
        document.getElementById("btnConsultar").click();
        };
    }

    /* PANETON */
    if (!entrega.PANETON?.ENTREGADO) {
        document.getElementById("btnPaneton").onclick = async () => {
        await update(ref(db,`aguinaldo/${dni}/ENTREGA/PANETON`),{
            ENTREGADO:true,
            FECHA:new Date().toISOString()
        });
        alert("Panetón registrado ✔");
        document.getElementById("btnConsultar").click();
        };
    }

    /* TARJETAS HIJOS */
    if (hijos > 0 && !tarjetasEntregadas) {
        document.getElementById("btnTarjetasHijos").onclick = async () => {
        const inputs = document.querySelectorAll(".codigoHijo");
        let data = {};

        for (let i of inputs) {
            if (!i.value.trim()) {
            return alert("Debe ingresar todos los códigos de los hijos");
            }
            data[`hijo${i.dataset.hijo}`] = i.value.trim();
        }

        await update(ref(db,`aguinaldo/${dni}/ENTREGA/HIJOS/TARJETAS`),{
            ENTREGADO:true,
            CODIGOS:data,
            FECHA:new Date().toISOString()
        });

        alert("Tarjetas hijos registradas ✔");
        document.getElementById("btnConsultar").click();
        };
    }

    /* PANETONCITOS */
    if (hijos > 0 && !entrega.HIJOS?.PANETONCITO?.ENTREGADO) {
        document.getElementById("btnPanetoncito").onclick = async () => {
        await update(ref(db,`aguinaldo/${dni}/ENTREGA/HIJOS/PANETONCITO`),{
            ENTREGADO:true,
            FECHA:new Date().toISOString()
        });
        alert("Panetoncitos entregados ✔");
        document.getElementById("btnConsultar").click();
        };
    }

    /* SORPRESAS */
    if (hijos > 0 && !entrega.HIJOS?.SORPRESA?.ENTREGADO) {
        document.getElementById("btnSorpresa").onclick = async () => {
        await update(ref(db,`aguinaldo/${dni}/ENTREGA/HIJOS/SORPRESA`),{
            ENTREGADO:true,
            FECHA:new Date().toISOString()
        });
        alert("Sorpresas entregadas ✔");
        document.getElementById("btnConsultar").click();
        };
    }
    };
    </script>

    </body>
    </html>

